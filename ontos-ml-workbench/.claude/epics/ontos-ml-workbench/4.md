---
name: Template Library API - Prompt Management Service
status: open
created: 2026-02-06T16:44:03Z
updated: 2026-02-06T16:44:03Z
github: https://github.com/databricks-field-eng/mirion-workspace/issues/4
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Template Library API - Prompt Management Service

## Description

Build the backend API and Pydantic models for Prompt Template management. Templates define reusable prompts with system/user messages, model configuration, and crucially the `label_type` field that enables canonical label matching. This task implements CRUD operations and template versioning.

## Acceptance Criteria

- [ ] Pydantic model `PromptTemplate` with all fields from schema including `label_type`
- [ ] API endpoints: POST, GET (list), GET (detail), PUT, DELETE for `/api/v1/templates`
- [ ] Support for template versioning (semantic versioning: 1.0.0, 1.0.1, etc.)
- [ ] Support for template status: `draft`, `published`, `archived`
- [ ] Jinja2 template validation for `user_prompt_template` field
- [ ] Preview endpoint to test template with sample data
- [ ] Filter templates by `label_type` for Q&A generation

## Technical Details

**Pydantic Models:**
```python
# backend/app/models/template.py
class PromptTemplate(BaseModel):
    id: str = Field(default_factory=lambda: f"template-{uuid4()}")
    name: str
    version: str = "1.0.0"  # Semantic versioning
    status: Literal["draft", "published", "archived"] = "draft"
    label_type: str  # e.g., "entity_extraction", "classification", "summarization"
    system_prompt: str
    user_prompt_template: str  # Jinja2 template
    input_schema: List[SchemaField] = []
    output_schema: List[SchemaField] = []
    base_model: str = "databricks-dbrx-instruct"
    temperature: float = 0.7
    max_tokens: int = 1000
    examples: List[Dict] = []
    created_by: str
    created_at: datetime
    updated_at: datetime

class SchemaField(BaseModel):
    name: str
    type: str
    description: str
    required: bool = True
```

**API Endpoints:**
```python
# backend/app/api/v1/templates.py
@router.post("/templates", response_model=PromptTemplate)
async def create_template(template: TemplateCreate, db: DatabricksSession)

@router.get("/templates", response_model=List[PromptTemplate])
async def list_templates(
    label_type: Optional[str] = None,
    status: Optional[str] = None,
    db: DatabricksSession = Depends()
)

@router.get("/templates/{template_id}", response_model=PromptTemplate)
async def get_template(template_id: str, db: DatabricksSession)

@router.put("/templates/{template_id}", response_model=PromptTemplate)
async def update_template(template_id: str, template: TemplateUpdate, db: DatabricksSession)

@router.post("/templates/{template_id}/preview")
async def preview_template(template_id: str, sample_data: Dict, db: DatabricksSession)
```

**Service Layer:**
```python
# backend/app/services/template_service.py
class TemplateService:
    def validate_jinja2_template(self, template: str) -> bool
    def render_template(self, template: str, data: Dict) -> str
    def increment_version(self, current_version: str) -> str
    def get_templates_by_label_type(self, label_type: str) -> List[PromptTemplate]
```

**Files to Create/Modify:**
```
backend/app/
├── models/template.py
├── api/v1/templates.py
├── services/template_service.py
└── main.py (register router)
```

## Dependencies

- [ ] Task 001 (Delta tables created)
- [ ] Jinja2 library installed (`pip install jinja2`)
- [ ] Foundation Model API configuration in backend

## Effort Estimate

- Size: M
- Hours: 12-16 hours
- Parallel: true (can run alongside Tasks 002, 004)

## Definition of Done

- [ ] All endpoints implemented and working
- [ ] Jinja2 template validation prevents invalid syntax
- [ ] Preview endpoint renders template with sample data successfully
- [ ] Templates can be filtered by `label_type` and `status`
- [ ] Version incrementing works (1.0.0 → 1.0.1)
- [ ] Created templates visible in Unity Catalog table
- [ ] Backend CLAUDE.md updated with Template API patterns
