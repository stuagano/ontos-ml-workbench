#!/bin/bash
#
# Git Pre-Commit Hook - Schema Verification
#
# To install: cp .git-hooks/pre-commit.example .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#
# This hook runs schema verification before allowing commits that touch
# schema-related files, preventing schema mismatches from being committed.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if any schema-related files are being committed
SCHEMA_FILES=$(git diff --cached --name-only | grep -E '(schemas/.*\.sql|app/models/.*\.py|app/api/v1/endpoints/.*\.py)' || true)

if [ -z "$SCHEMA_FILES" ]; then
    # No schema files changed, allow commit
    exit 0
fi

echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}Schema files detected in commit${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo
echo "Changed files:"
echo "$SCHEMA_FILES" | sed 's/^/  - /'
echo
echo -e "${YELLOW}Running schema verification...${NC}"
echo

# Run schema verification
cd backend
if python3 ../schemas/verify_schema.py; then
    echo
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✅ Schema verification passed${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    exit 0
else
    echo
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}❌ Schema verification failed${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo
    echo "Schema mismatch detected. Please:"
    echo "  1. Review schemas/SCHEMA_REFERENCE.md for correct schema"
    echo "  2. Update your code to match the database schema"
    echo "  3. Run: cd backend && python3 ../schemas/verify_schema.py"
    echo
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo
    exit 1
fi
