---
name: Example Store Schema + API - Vector-Backed Few-Shot (P1)
status: open
created: 2026-02-06T16:44:03Z
updated: 2026-02-06T16:44:03Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: Example Store Schema + API - Vector-Backed Few-Shot (P1)

## Description

**Priority:** P1 (deferred after MVP)

Build the Example Store backend for managing few-shot examples with semantic similarity retrieval. Examples are stored in Delta Lake with Databricks Vector Search index for cosine similarity queries. This enables dynamic few-shot learning where agents retrieve relevant examples at runtime based on query similarity.

**Use Case:** Agent fails to invoke correct tool → create example demonstrating expected behavior → subsequent similar queries retrieve example and guide model.

## Acceptance Criteria

- [ ] Delta table `example_store` created with vector embedding column
- [ ] Databricks Vector Search index created on embeddings
- [ ] API endpoints: POST, GET, DELETE for `/api/v1/examples`
- [ ] Similarity search endpoint: POST `/api/v1/examples/search` with query text
- [ ] Automatic embedding generation using `ai_embed` or Foundation Model API
- [ ] Filter examples by `function_name`, `domain`, or `quality_score`
- [ ] Return top-k most similar examples (default k=5)
- [ ] Support for text and function calling examples

## Technical Details

**Example Schema (Delta Table):**
```sql
CREATE TABLE mirion_vital.workbench.example_store (
  id STRING PRIMARY KEY,
  input VARIANT,              -- User query or input demonstrating scenario
  expected_output VARIANT,    -- Expected model response
  search_keys ARRAY<STRING>,  -- Semantic keywords for matching
  embedding ARRAY<FLOAT>,     -- Vector embedding for similarity search
  function_name STRING,       -- Optional: tool/function this demonstrates
  domain STRING,              -- Optional: use case category
  quality_score FLOAT,        -- 0-1, human or automated rating
  created_by STRING,
  created_at TIMESTAMP
);

-- Create Vector Search index
CREATE VECTOR SEARCH INDEX example_store_index
ON mirion_vital.workbench.example_store(embedding)
INDEXED COLUMNS (function_name, domain);
```

**Pydantic Models:**
```python
# backend/app/models/example.py
class Example(BaseModel):
    id: str
    input: Dict  # User query or scenario
    expected_output: Dict  # Expected behavior
    search_keys: List[str]
    embedding: Optional[List[float]] = None  # Generated automatically
    function_name: Optional[str] = None
    domain: Optional[str] = None
    quality_score: float = 0.5
    created_by: str
    created_at: datetime
```

**API Endpoints:**
```python
# backend/app/api/v1/examples.py
@router.post("/examples", response_model=Example)
async def create_example(example: ExampleCreate, db: DatabricksSession):
    # Generate embedding from input text
    embedding = await embedding_service.generate_embedding(example.input)
    example.embedding = embedding
    # Insert into Delta table
    return example

@router.post("/examples/search", response_model=List[Example])
async def search_examples(
    query: str,
    function_name: Optional[str] = None,
    domain: Optional[str] = None,
    top_k: int = 5,
    min_quality: float = 0.0,
    db: DatabricksSession = Depends()
):
    # 1. Generate query embedding
    query_embedding = await embedding_service.generate_embedding(query)

    # 2. Vector similarity search
    results = await vector_search_service.search(
        embedding=query_embedding,
        filters={"function_name": function_name, "domain": domain},
        top_k=top_k,
        min_score=min_quality
    )

    return results

@router.get("/examples", response_model=List[Example])
async def list_examples(
    function_name: Optional[str] = None,
    domain: Optional[str] = None,
    db: DatabricksSession = Depends()
)

@router.delete("/examples/{example_id}")
async def delete_example(example_id: str, db: DatabricksSession)
```

**Service Layer:**
```python
# backend/app/services/embedding_service.py
class EmbeddingService:
    async def generate_embedding(self, text: str) -> List[float]:
        # Use Databricks ai_embed or Foundation Model API
        pass

# backend/app/services/vector_search_service.py
class VectorSearchService:
    async def search(
        self,
        embedding: List[float],
        filters: Dict,
        top_k: int,
        min_score: float
    ) -> List[Example]:
        # Query Databricks Vector Search index
        pass
```

**Files to Create:**
```
backend/app/
├── models/example.py
├── api/v1/examples.py
├── services/embedding_service.py
├── services/vector_search_service.py
└── main.py (register router)

schemas/
└── 08_example_store.sql (Vector Search index DDL)
```

## Dependencies

- [ ] Task 001 (Delta tables)
- [ ] Databricks Vector Search enabled on workspace
- [ ] Foundation Model API or ai_embed function for embeddings
- [ ] Vector Search Python client library

## Effort Estimate

- Size: L
- Hours: 16-20 hours
- Parallel: true (P1 - deferred, no blocking dependencies)

## Definition of Done

- [ ] Delta table + Vector Search index created
- [ ] Examples can be created with automatic embedding generation
- [ ] Similarity search returns relevant examples
- [ ] Filtering by function_name and domain works
- [ ] Top-k parameter limits results correctly
- [ ] Manual test: Create 10 examples, search with similar query → verify cosine similarity ranking
- [ ] Backend CLAUDE.md updated with Example Store patterns

**Note:** This is P1 (deferred). Ship MVP (Tasks 001-008) first, then add Example Store later.
